{{ config(
    materialized='incremental',
    unique_key='consumerid',
    on_schema_change='fail'
) }}

with source_data as (
    select *
    from {{ source('consumer', 'stream_append_attributes') }}
    where metadata$action = 'INSERT'
    {% if is_incremental() %}
        and metadata$isupdate = false
    {% endif %}
),

consumer_exists as (
    select consumerid
    from {{ source('consumer', 'consumer') }}
),

transformed as (
    select
        aa.consumerid,
        aa.age,
        aa.agerange_18_24yearsold,
        aa.agerange_25_34yearsold,
        aa.agerange_35_44yearsold,
        aa.agerange_45_54yearsold,
        aa.agerange_55_64yearsold,
        aa.agerange_65_74yearsold,
        aa.agerange_75plusyearsold,
        aa.age_year_of_birth,
        aa.age_month_of_birth,
        aa.boughtusingamex,
        aa.buyer_high_end_spirit_drinkers,
        aa.buyer_imported_beer_enthusiast,
        aa.buyerhighscalecatalogorders,
        aa.buyerorderstravel,
        aa.censusincomepercentile,
        aa.collectibles,
        aa.county_fips,
        aa.county_name,
        aa.children_age_0_3_gender,
        aa.children_age_4_6_gender,
        aa.children_age_7_9_gender,
        aa.children_age_10_12_gender,
        aa.children_age_13_15_gender,
        aa.children_age_16_18_gender,
        aa.consumer_buying_style_email,
        aa.consumer_buying_style_savvy_researchers,
        aa.consumer_buying_style_organic_and_natural,
        aa.consumer_buying_style_brand_loyalists,
        aa.consumer_buying_style_trendsetters,
        aa.consumer_buying_style_deal_seekers,
        aa.consumer_buying_style_recreational_shoppers,
        aa.consumer_buying_style_in_the_moment_shoppers,
        aa.consumer_buying_style_quality_matters,
        aa.consumer_buying_style_mainstream_adopters,
        aa.consumer_buying_style_novelty_seekers,
        aa.consumer_preferred_adv_channel_broadcast_cable_tv,
        aa.consumer_preferred_adv_channel_digital_display,
        aa.consumer_preferred_adv_channel_direct_mail,
        aa.consumer_preferred_adv_channel_digital_newspaper,
        aa.consumer_preferred_adv_channel_digital_video,
        aa.consumer_preferred_adv_channel_radio,
        aa.consumer_preferred_adv_channel_streaming_tv,
        aa.consumer_preferred_adv_channel_traditional_newspaper,
        aa.consumer_preferred_adv_channel_mobile_sms_mms,
        aa.dma,
        aa.dma_code,
        aa.donor,
        aa.dwellingtype_multifamily,
        aa.dwellingtype_pobox,
        aa.dwellingtype_singlefamily,
        aa.dwelling_number_of_units,
        aa.education_lessthanhighschooldiploma,
        aa.education_highschooldiploma,
        aa.education_somecollege,
        aa.education_bachelordegree,
        aa.education_graduatedegree,
        aa.education_unknown,
        aa.educationlevel,
        aa.family_new_parent_36m_indicator,
        aa.gender,
        aa.geovectordesc,
        aa.grandchildren,
        aa.hastakencruisevacation,
        aa.hobby_birdwatching,
        aa.hobby_books_literature,
        aa.interest_book_reader,
        aa.interest_e_book_reader,
        aa.interest_audio_book_listener,
        aa.interest_pet_enthusiastinterest_pet_enthusiast,
        aa.hobby_casinogambling,
        aa.hobby_cigarsmoking,
        aa.hobby_cooking,
        aa.hobby_crafts,
        aa.hobby_cultural_history,
        aa.hobby_diy,
        aa.hobby_entrepreneur,
        aa.hobby_exercise3ormoretimesweek,
        aa.hobby_gardening,
        aa.hobby_gourmetcooking,
        aa.hobby_homeliving,
        aa.hobby_mens_fashion,
        aa.hobby_news_politics,
        aa.hobby_photography,
        aa.hobby_selfimprovementcourses,
        aa.hobby_theaterarts,
        aa.hobby_wineappreciation,
        aa.hobby_womens_fashion,
        aa.homeownership_owner,
        aa.homeownership_renter,
        aa.homevaluerange,
        aa.householdcompositionrollup_adultfemalewchildren,
        aa.householdcompositionrollup_adultfemale,
        aa.householdcompositionrollup_adultmalefemalewchildren,
        aa.householdcompositionrollup_adultmalefemale,
        aa.householdcompositionrollup_adultmalewchildren,
        aa.householdcompositionrollup_adultmale,
        aa.incomerange,
        aa.investments,
        aa.lengthofresidence,
        aa.lifestyle_proud_grandparent_survey,
        aa.lifestyle_buys_via_direct_mail_survey,
        aa.mailorderresponder,
        aa.maritalstatus_married,
        aa.maritalstatus_single,
        aa.movedbetween_dec_12_2022_and_nov_30_2023,
        aa.msa,
        aa.networth,
        aa.numberofadultsinhh,
        aa.numberofchildren,
        aa.numberofchildreninhh,
        aa.numberofpersonsinhh,
        aa.occupation_agricultureenvironment,
        aa.occupation_bluecollar,
        aa.occupation_business_owner,
        aa.occupation_businessadmin,
        aa.occupation_clergy,
        aa.occupation_disabled,
        aa.occupation_education,
        aa.occupation_finance,
        aa.occupation_legal,
        aa.occupation_sales,
        aa.occupation_medical,
        aa.occupation_militarygovernment,
        aa.occupation_operatehomebusiness,
        aa.occupation_retired,
        aa.occupation_selfemployed,
        aa.occupation_student,
        aa.occupation_whitecollar,
        aa.ownscat,
        aa.ownsdog,
        aa.percentsinglefamilydwelling,
        aa.premiumamex,
        aa.presenceofchildren0_2,
        aa.presenceofchildren11_15,
        aa.presenceofchildren16_17,
        aa.presenceofchildren3_5,
        aa.presenceofchildren6_10,
        aa.presenceofelderlyparent,
        aa.presence_of_young_adult,
        aa.presence_of_child_overall_0_18,
        aa.religion,
        aa.sports_biking,
        aa.sports_boating,
        aa.sports_campinghiking,
        aa.sports_fishing,
        aa.sports_fitness,
        aa.sports_general,
        aa.sports_golf,
        aa.sports_nascar,
        aa.sports_scuba,
        aa.sports_skiing,
        aa.sports_tennis,
        aa.sports_walking,
        aa.interest_disney_park_fan,
        aa.interest_july_4th_travelers_lm,
        aa.interest_summer_break_travelers_lm,
        aa.interest_theme_parks_lm,
        aa.interest_travel_rewards,
        aa.interest_frequent_air_traveler,
        aa.interest_sweepstakes_lottery,
        aa.interest_weight_conscious,
        aa.interest_on_a_diet,
        aa.interest_healthy_living,
        aa.interest_sports_enthusiast,
        aa.interest_snow_sports,
        aa.interests_travel_bb,
        aa.interests_affluent_lifestyle_bb,
        aa.interest_travel_cruise,
        aa.interest_travel_time_share,
        aa.interest_travel_business_travel,
        aa.interest_travel_personal_travel,
        aa.travel_expenditures_rank_0_25,
        aa.travel_expenditures_rank_26_50,
        aa.travel_expenditures_rank_51_75,
        aa.travel_expenditures_rank_76_90,
        aa.travel_expenditures_rank_91_100,
        aa.interest_amusement_parks,
        aa.interest_zoos,
        aa.interest_coffee_connoisseurs,
        aa.interest_wine_lovers,
        aa.interest_home_improvement_spenders,
        aa.interest_hunting_enthusiasts,
        aa.interest_digital_magazine_newspapers_buyers,
        aa.interest_attend_or_ordereducationalprograms,
        aa.travel_expenditures_annual_spend,
        aa.interest_eats_at_family_restaurants,
        aa.interest_eats_at_fast_food_restaurants,
        aa.interest_canoeing_kayaking,
        aa.interest_gourmet_cooking,
        aa.interest_avid_runners,
        aa.interest_outdoor_enthusiast,
        aa.lifestyle_high_frequency_business_traveler,
        aa.lifestyle_high_frequency_cruise_enthusiast,
        aa.lifestyle_high_frequency_domestic_vacationer,
        aa.lifestyle_high_frequency_foreign_vacationer,
        aa.lifestyle_frequent_flyer_program_member,
        aa.lifestyle_hotel_guest_loyalty_program,
        aa.travel_casinovacations,
        aa.travel_familyvacations,
        aa.travel_frequentflyers,
        aa.travel_international,
        aa.travel_personalservices,
        aa.travel_us,
        aa.upscaleretail,
        aa."urban_metro_urban20k+metroadjacent",
        aa.urban_metro_metrocountieslessthan250k,
        aa."urban_metro_ruralorlessthan2.5kurban_not_adjacent",
        aa."urban_metro_ruralorlessthan2.5kurban_adjacent",
        aa."urban_metro_metrocounties250k-1m",
        aa."urban_metro_urban_2.5k-19.99k_not_adjacent",
        aa."urban_metro_urban2.5k-19.99kadjacent",
        aa."urban_metro_urban_20k+notadjacent",
        aa."urban_metro_metro counties 1m+",
        aa.wealthpercentile,
        aa.hobby_computers_electronics,
        aa.mosaic,
        aa.mosaic_group,
        aa.interest_travel_domestic,
        current_timestamp() as processed_at
    from source_data aa
    inner join consumer_exists c 
        on aa.consumerid = c.consumerid
)

select * from transformed 